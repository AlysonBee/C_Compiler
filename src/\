

#include <unistd.h>
#include "../../inc/compiler.h"

char    *create_path(char *path, char *filename)
{
    char *newpath;
    char *temp;

    if (strchr(filename, '/')) 
    {
        size_t  file_len = strlen(filename) - 1;
        char    *to_ret;

        while (filename[file_len] != '/')
            file_len--;
        newpath = strndup(filename,file_len);
        to_ret = join(path, newpath);
        free(newpath);
        return (to_ret);
    }
    temp = join(path, "/");
    newpath = join(temp, filename);
    free(temp);
    return (newpath);
}


static char    *handle_system_lib(char *lib_name)
{
    char        *system_path;
    char        *filename;
    char        *abspath;
    char        *content;
    
    filename = sub(lib_name, 1, strlen(lib_name) - 2);
    system_path = strdup("/Library/Developer/CommandLineTools/usr/include/c++/v1/");
    abspath = join(system_path, filename);
    content = file_content(abspath);
    free(abspath);
    free(filename);
    free(system_path);
    return (content);
}

static char    *handle_local_lib(char *lib_name, char *filename)
{
    char    directory[1024];
    char    *abspath;
    char    *segname;
    
    segname = sub(lib_name, 1, strlen(lib_name) - 2);
    bzero(directory, 1024);
    getcwd(directory, 1024);
    abspath = create_path(directory, segname);
    printf("abspath is %s\n", abspath);
    return (NULL);
}


char  *handle_include(char *content, size_t size, char *filename)
{
    char    *lib_name;
    size_t  filesize;
    char    *segment;
    extern size_t end;

    filesize = strlen(content);
    lib_name = NULL;
    size++;
    do 
    {
        lib_name = charpush(lib_name, content[size]);
        size++;
    }
    while (content[size] != ' ' && content[size] != '\t' &&
          content[size] != '\n' && size < filesize);
    while (content[size] != '\n')
    {
        if (content[size]  != '\t' || content[size] != ' ')
            return (NULL);
        size++;
    }
    end = size;
    printf("lib_name : %s\n\n\n\n", lib_name);
    if (startswith(lib_name, '<') == 1 && endswith(lib_name, '>') == 1)
    {
         segment = handle_system_lib(lib_name);
         free(lib_name);
         return (segment);
    }

    else if (startswith(lib_name,'"') == 1 && endswith(lib_name, '"') == 1)
    {
        handle_local_lib(lib_name, filename);
        free(lib_name);
        exit(1);
    } 
    return (NULL);
}
